<div id="docinput" class="modal fade" tabindex="-1" role="dialog">
  <div class="modal-dialog modal-dialog-centered modal-xl" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Жіберілгені жайлы АКТ</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">

        <form action="/test" method="POST">
          <div class="row">
            <label for="date" class="col-2 col-form-label-sm">Дата</label>
            <div class="col-3">
              <input id="date" type="date" class="form-control form-control-sm" placeholder="Дата" name="date" required>
            </div>
            <label for="autoequipment" class="col-2 col-form-label-sm">Автокөлік</label>
            <div class="col">
              <select class="form-control form-control-sm" id="autoequipment" name="autoequipment" required>
                <option value="">Таңдаңыз</option>
              </select>
            </div>
          </div>
          <div class="row">

          </div>
          <div class="row">
            <label for="employee" class="col-2 col-form-label-sm">Қабылдаған</label>
            <div class="col">
              <select class="form-control form-control-sm" id="employee" name="employee" required>
                <option value="">Таңдаңыз</option>
              </select>
            </div>
          </div>

          <table class="table table-sm table-light table-hover">
            <thead class="thead-light">
              <tr class="text-center">
                <th scope="col" class="w-50">Атауы</th>
                <th scope="col" class="sr-only">Ұзындығы</th>
                <th scope="col" class="w-25">Саны</th>
                <th scope="col">Жалпы ұзындығы</th>
                <th scope="col"></th>
              </tr>
            </thead>
            <tbody class="tbody">
              <tr>
                <td>
                  <select name="pipe[]" class="form-control form-control-sm current" required><option value="">....</option></select>
                </td>
                <td class="text-right sr-only">
                  <!-- <input type="number" hidden> -->
                </td>
                <td>
                  <input type="number" class="form-control form-control-sm text-right" name="quantity[]" step="1" min="1" required>
                </td>
                <td class="text-right"></td>
                <td class="text-right"><i class="far fa-trash-alt"></i></td>
              </tr>
              <tr class="addrow">
                <td colspan=5><a class="btn btn-sm btn-outline-info" href="#">Тағы да...</a></td>
            </tbody>
          </table>
          <button type="submit" class="btn btn-primary btn-sm" name="template" hidden>Submit</button>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary btn-sm" data-dismiss="modal">Жауып таста</button>
        <button id="" type="button" class="btn btn-primary btn-sm sec_btn_caption">Базаға сақта</button>
      </div>
    </div>
  </div>
</div>

<script>
  function init(container) {

    var submitButton = $(container + ' button').filter('[name="template"]');

    submitButton.click(function(e) {
      isValid = $(container + ' form')[0].checkValidity();

      if( false === isValid ) return true;
      // true деп қайтармасаң валидацияны көрсетпейді
      e.preventDefault();
      
      $.ajax({
        method: 'POST',
        url: '/releaseInsert',
        data: $(container + ' form').serialize(),
        success: function(res, sts, xhr) {
          $(container + ' #docinput').modal('hide');
        },
        error: function(xhr, sts, err) {
          alert('Server not response', err);
        }
      });
    });

    $(container + ' .sec_btn_caption').on('click', function() {
      submitButton.trigger('click');
    });

    $(container + ' .tbody').on("click", "i", function () {
      $(this).parent().parent().remove();
    });

    $(container + ' .tbody').on('change', 'select', function() {
      len = this.parentElement.nextElementSibling.innerText = pipelength[this.value];
      qty = this.parentElement.nextElementSibling.nextElementSibling.firstElementChild.value;
      this.parentElement.nextElementSibling.nextElementSibling.nextElementSibling.innerHTML = len * qty;
    });

    $(container + ' .tbody').on('change', 'input', function() {
        qty = this.value;
        len = this.parentElement.previousElementSibling.innerText;
        this.parentElement.nextElementSibling.innerHTML = len * qty;
    });

    // Кейін көремін, jQuery мен үшін әлі түсініксіздеу
    // $(container + ' .tbody').on('change','tr', function() {
    //   len = $(this).find('input')[0].value = pipes[$(this).find('select')[0].value].length;
    //   qty = $(this).find('input')[1].value;
    //   $(this).find('td:nth-child(4)')[0].innerHTML = len * qty;
    // });

    $.post('/employees', function (data) {
      data.forEach(element => {
        $('#employee').append(`<option value=${element.id_employee}>${element.name}, ${element.position}</option>`);
      });
    });

    $.post('/autoequipments', function (data) {
      data.forEach(element => {
        $('#autoequipment').append(`<option value=${element.id_auto}>${element.gosnumber}</option>`);
      });
    });

    $.post('/pipes', function (data) {
      pipes = data;
      data.forEach(element => {
        $('.current:first').append(`<option value=${element.id_pipe}>${element.pipe}</option>`);
        pipelength[element.id_pipe] = element.length;
      });
      $('.current:first').removeClass('current');
    });

    $(container + ' .tbody .btn').click(function () {
      var tableRow = '<tr><td><select name="pipe[]" class="form-control form-control-sm current" required><option value="">....</option></select></td>' +
      '<td class="text-right sr-only"></td>' +
      '<td><input type="number" class="form-control form-control-sm text-right" name="quantity[]" step="1" min="1" required></td>' +
      '<td class="text-right"></td><td class="text-right"><i class="far fa-trash-alt"></i></td></tr>';

      $(container + ' .addrow').before(tableRow);

      pipes.forEach(element => {
        $(container + ' .current:first').append(`<option value=${element.id_pipe}>${element.pipe}</option>`);
      });

      $(container + ' .current:first').removeClass('current');

      return false;
    });

    $(container + ' #docinput').modal({ show: true, backdrop: false });

  }

</script>